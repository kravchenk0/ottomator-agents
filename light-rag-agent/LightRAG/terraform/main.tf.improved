# Улучшенная логика Security Group для исправления проблемы с портом 8000

# Добавить в locals блок в main.tf (строки 97-122):
locals {
  # Base ingress rules: always include SSH
  ingress_ports_base = [
    { from = 22, to = 22, description = "SSH" }
  ]
  
  # Add HTTP/HTTPS ports only if ALB is disabled (direct access mode)
  ingress_ports_web = var.enable_alb ? [] : [
    { from = 80,  to = 80,  description = "HTTP" },
    { from = 443, to = 443, description = "HTTPS" }
  ]
  
  # УЛУЧШЕННАЯ ЛОГИКА: Порт 8000 добавляется если:
  # 1. ALB отключён (прямой доступ) ИЛИ
  # 2. debug_open_app_port = true ИЛИ  
  # 3. enable_public_api = true (новая переменная для production)
  should_open_port_8000 = !var.enable_alb || var.debug_open_app_port || var.enable_public_api
  
  ingress_ports_app = local.should_open_port_8000 ? [
    { 
      from = 8000, 
      to = 8000, 
      description = var.enable_alb ? 
        (var.debug_open_app_port ? "DEBUG: Direct 8000 access" : "API public access") : 
        "LightRAG API" 
    }
  ] : []
  
  # Combine all ingress rules
  ingress_ports = concat(
    local.ingress_ports_base,
    local.ingress_ports_web, 
    local.ingress_ports_app
  )
  
  effective_ingress_cidrs = length(var.allowed_ingress_cidrs) > 0 ? var.allowed_ingress_cidrs : ["0.0.0.0/0"]
}

# ОСТАВИТЬ ВЕСЬ ОСТАЛЬНОЙ КОД БЕЗ ИЗМЕНЕНИЙ
# Этот файл показывает только изменённую логику