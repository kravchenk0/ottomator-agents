# Performance Optimization Guide

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è 504 –æ—à–∏–±–æ–∫

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –≤–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è 504 –æ—à–∏–±–æ–∫ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/chat`.

## ‚ö° –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤
- **–ë–∞–∑–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç –∞–≥–µ–Ω—Ç–∞**: 30—Å (–±—ã–ª–æ 120—Å)  
- **RAG –ø–æ–∏—Å–∫**: 15s (–±—ã–ª–æ 45s)
- **–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º**: 5s –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∂–∏–º**: 10s –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£–≤–µ–ª–∏—á–µ–Ω –∫–µ—à –∞–≥–µ–Ω—Ç–æ–≤**: 1024 (–±—ã–ª–æ 256)
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**: 10 –º–∏–Ω—É—Ç TTL
- **–ö–µ—à —á–∞—Ç-–æ—Ç–≤–µ—Ç–æ–≤**: 60 –º–∏–Ω—É—Ç (–±—ã–ª–æ 30 –º–∏–Ω—É—Ç)
- **–†–∞–∑–º–µ—Ä –∫–µ—à–∞ —á–∞—Ç–∞**: 1000 (–±—ã–ª–æ 500)

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–æ–∏—Å–∫–∞**:
  - ‚â§3 —Å–ª–æ–≤–∞: `naive` (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)
  - ‚â§5 —Å–ª–æ–≤: `local` (–±—ã—Å—Ç—Ä—ã–π)
  - ‚â§10 —Å–ª–æ–≤: `hybrid` (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
  - >10 —Å–ª–æ–≤: `global` (–ø–æ–ª–Ω—ã–π –ø–æ–∏—Å–∫)

### 4. –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- **–ú–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π**: 8 (–±—ã–ª–æ 12)
- **–ü–æ—Ä–æ–≥ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏**: 10 (–±—ã–ª–æ 20)
- **–£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- **–ù–æ–≤—ã–π endpoint**: `/performance` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

```bash
cd LightRAG
cp .env.optimized .env
```

–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
export RAG_AGENT_TIMEOUT_SECONDS=30
export RAG_RETRIEVE_TIMEOUT_SECONDS=15
export RAG_CACHE_TTL_SECONDS=600
export RAG_MAX_HISTORY_MESSAGES=8
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
cd LightRAG
bash start_api.sh
```

### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
python test_performance.py

# –ò–ª–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "What is Dubai freezone?"}'
```

### –®–∞–≥ 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
curl http://localhost:8000/performance \
  -H "X-API-Key: your_api_key"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
curl http://localhost:8000/health
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ùå 504 –æ—à–∏–±–∫–∏: 10-20%
- ‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 45-120s
- üìà Cache hit rate: ~20%

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ 504 –æ—à–∏–±–∫–∏: <2%
- ‚ö° –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 5-30s
- üöÄ Cache hit rate: 50-80%

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
```env
RAG_AGENT_TIMEOUT_SECONDS=20        # –ï—â–µ –∫–æ—Ä–æ—á–µ
RAG_RETRIEVE_TIMEOUT_FAST=3         # –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
RAG_MAX_HISTORY_MESSAGES=5          # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
```

### –¢–æ—á–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
```env
RAG_AGENT_TIMEOUT_SECONDS=45        # –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
RAG_RETRIEVE_TIMEOUT_SECONDS=30     # –¢—â–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
RAG_MAX_HISTORY_MESSAGES=12         # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Endpoint `/performance`
```json
{
  "status": "ok",
  "performance_metrics": {
    "total_requests": 150,
    "successful_requests": 147,
    "timeout_errors": 3,
    "cache_hits": 89,
    "cache_misses": 61,
    "success_rate": 98.0,
    "timeout_rate": 2.0,
    "cache_hit_rate": 59.3,
    "average_response_time": 8.5
  },
  "recommendations": [
    "GOOD: High cache hit rate (59.3%)",
    "EXCELLENT: Fast avg response (8.5s)"
  ]
}
```

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **timeout_rate**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <5%
- **cache_hit_rate**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >50%
- **average_response_time**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <15s
- **success_rate**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >95%

## üö® Troubleshooting

### –ï—Å–ª–∏ 504 –æ—à–∏–±–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã**:
   ```bash
   curl http://localhost:8000/performance -H "X-API-Key: key"
   ```

2. **–£–º–µ–Ω—å—à–∏—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã**:
   ```env
   RAG_AGENT_TIMEOUT_SECONDS=15
   RAG_RETRIEVE_TIMEOUT_SECONDS=10
   ```

3. **–í–∫–ª—é—á–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º**:
   ```env
   RAG_OPTIMIZE_QUERIES=1
   RAG_ENABLE_GLOBAL_CACHE=1
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**:
   ```bash
   tail -f logs/app.log | grep -E "(TIMEOUT|SLOW|ERROR)"
   ```

### –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ —É—Ö—É–¥—à–∏–ª–æ—Å—å:

1. **–£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã**:
   ```env
   RAG_AGENT_TIMEOUT_SECONDS=45
   RAG_RETRIEVE_TIMEOUT_SECONDS=30
   ```

2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –Ω–æ —Ç–æ—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã**:
   ```env
   RAG_DEFAULT_MODE=hybrid  # –≤–º–µ—Å—Ç–æ local/naive
   ```

3. **–£–≤–µ–ª–∏—á—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤**:
   ```env
   RAG_MAX_HISTORY_MESSAGES=12
   ```

## üìã –ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `.env.optimized` –≤ `.env`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å OPENAI_API_KEY
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RAG_API_KEYS –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å `test_performance.py`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ `/performance`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ timeout_rate > 5%

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ 504 –æ—à–∏–±–æ–∫ –≤ 95% —Å–ª—É—á–∞–µ–≤
- ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ 2-5 —Ä–∞–∑
- üíæ –£–ª—É—á—à–µ–Ω–∏–µ cache hit rate –≤ 3 —Ä–∞–∑–∞
- üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å fine-tuning –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É