# Оптимизация производительности чата

## Что было оптимизировано

### 1. Многоуровневое кеширование
- **RAG запросы**: Кеш на 5 минут с автоочисткой
- **Полные ответы чата**: Кеш на 30 минут для идентичных вопросов
- **Агенты**: LRU кеш для создания агентов (256 экземпляров)

### 2. Адаптивные таймауты
```python
# Умные таймауты на основе сложности
Простые запросы (≤5 слов, ≤3 сообщений истории): 45с
Средние запросы (≤15 слов, ≤8 сообщений): 75с  
Сложные запросы: 120с (базовый)
```

### 3. Оптимизация RAG операций
- **Адаптивные режимы поиска**:
  - 1-3 слова: `local` режим (10с таймаут)
  - 4-7 слов: `hybrid` режим (30с таймаут) 
  - 8+ слов: `mix` режим (60с таймаут)
- **Интеллектуальный fallback**: при таймауте переключение на быстрый `local` режим

### 4. Умная обрезка истории
- Сохранение начальных и последних сообщений
- Маркер пропущенных сообщений для контекста
- Асинхронная обработка длинных историй

### 5. Оптимизированный системный промпт
- Сокращен с ~2000 до ~400 символов (5x меньше)
- Убраны подробные инструкции, оставлена суть
- Фокус на ключевых действиях

## Новые метрики для мониторинга

### Кеширование
- `lightrag_chat_cache_hits_total` - попадания в кеш
- `lightrag_chat_cache_misses_total` - промахи кеша
- `lightrag_rag_retrieve_latency_seconds_sum` - время RAG запросов

### Формула эффективности кеша:
```
Cache Hit Rate = cache_hits / (cache_hits + cache_misses) * 100%
```

## Переменные окружения для настройки

```bash
# Кеширование
RAG_CACHE_TTL_SECONDS=300                    # Кеш RAG запросов (5 мин)
RAG_CHAT_CACHE_TTL_SECONDS=1800              # Кеш ответов чата (30 мин)

# Адаптивные таймауты RAG
RAG_RETRIEVE_TIMEOUT_FAST=10                 # Простые запросы
RAG_RETRIEVE_TIMEOUT_MEDIUM=30               # Средние запросы  
RAG_RETRIEVE_TIMEOUT_SECONDS=60              # Сложные запросы

# Общий таймаут агента
RAG_AGENT_TIMEOUT_SECONDS=120                # Максимальный таймаут

# Управление историей
RAG_MAX_HISTORY_MESSAGES=12                  # Макс сообщений в истории
RAG_HISTORY_ASYNC_THRESHOLD=20               # Порог для async обработки
```

## Ожидаемые улучшения

### До оптимизации (из ваших метрик):
- Среднее время ответа: **112.97 секунд** (338.9/3)
- agent_run: **98.89 секунд** (87% от общего времени)

### После оптимизации:
- **Cache hits**: Мгновенный ответ (< 0.1с)
- **Простые запросы**: 10-30 секунд  
- **Средние запросы**: 30-60 секунд
- **Сложные запросы**: 60-90 секунд (все еще быстрее)

### Ожидаемый прирост производительности:
- **Cache hit rate 20-40%**: Экономия ~20-45 секунд на запрос
- **RAG оптимизация**: Экономия 30-50% времени на поиск
- **Адаптивные таймауты**: Предотвращение зависаний на простых запросах

## Мониторинг эффективности

### 1. Проверить cache hit rate:
```bash
curl -s http://localhost:8000/metrics | grep -E "(cache_hits|cache_misses)"

# Вычислить процент попадания в кеш
HITS=$(curl -s http://localhost:8000/metrics | grep "lightrag_chat_cache_hits_total" | awk '{print $2}')
MISSES=$(curl -s http://localhost:8000/metrics | grep "lightrag_chat_cache_misses_total" | awk '{print $2}')
TOTAL=$((HITS + MISSES))
if [ "$TOTAL" -gt 0 ]; then
  RATE=$(echo "scale=1; $HITS * 100 / $TOTAL" | bc)
  echo "Cache hit rate: $RATE%"
fi
```

### 2. Отслеживать среднее время RAG операций:
```bash
curl -s http://localhost:8000/metrics | grep -E "(rag_retrieve_latency|rag_retrieve_total)"

# Среднее время RAG запроса
LATENCY=$(curl -s http://localhost:8000/metrics | grep "lightrag_rag_retrieve_latency_seconds_sum" | awk '{print $2}')
COUNT=$(curl -s http://localhost:8000/metrics | grep "lightrag_rag_retrieve_total" | awk '{print $2}')
if [ "$COUNT" -gt 0 ]; then
  AVG=$(echo "scale=2; $LATENCY / $COUNT" | bc)
  echo "Average RAG retrieve time: ${AVG}s"
fi
```

### 3. Проверить распределение таймаутов:
```bash
# Посмотреть логи для анализа используемых таймаутов
tail -f /path/to/logs | grep "adaptive timeout"
```

## Дополнительные рекомендации

### Если производительность все еще низкая:

1. **Увеличить размер кеша агентов**:
   ```python
   @lru_cache(maxsize=512)  # Вместо 256
   ```

2. **Уменьшить время кеша для частых запросов**:
   ```bash
   RAG_CHAT_CACHE_TTL_SECONDS=3600  # 1 час вместо 30 минут
   ```

3. **Агрессивнее урезать таймауты**:
   ```bash
   RAG_RETRIEVE_TIMEOUT_FAST=5      # Очень быстрые запросы
   RAG_RETRIEVE_TIMEOUT_MEDIUM=15   # Средние запросы
   ```

4. **Использовать более быструю модель** для простых запросов:
   ```bash
   OPENAI_MODEL=gpt-4o-mini  # Быстрее чем gpt-4
   ```

### Если есть много повторяющихся вопросов:
- Cache hit rate должен быть 30-50%
- Рассмотрите увеличение времени жизни кеша до 1-2 часов

### Для очень высокой нагрузки:
- Рассмотрите внешний Redis для кеширования
- Горизонтальное масштабирование с load balancer
- Предварительное прогревание кеша популярными запросами