# üîç –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ /chat

## –ü—Ä–æ–±–ª–µ–º–∞
API `/chat` –Ω–µ –º–æ–≥ –Ω–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É:
```
"retrieve –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –æ—à–∏–±–∫–æ–π: ¬´name 'query_length' is not defined¬ª"
```

## –ü—Ä–∏—á–∏–Ω—ã (–¥–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)

### 1. **–û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ RAG agent (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)**
**–§–∞–π–ª:** `app/agent/rag_agent.py`, —Å—Ç—Ä–æ–∫–∞ 134  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `query_length`
```python
# –ë–´–õ–û (–æ—à–∏–±–∫–∞):
logger.info(f"[retrieve] query_len={query_length}, timeout={retrieve_timeout}s, mode={search_mode}")

# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
query_length = len(search_query)
logger.info(f"[retrieve] query_len={query_length}, timeout={retrieve_timeout}s, mode={search_mode}")
```

**–í–ª–∏—è–Ω–∏–µ:** RAG retrieve –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∏–∑-–∑–∞ —ç—Ç–æ–π –æ—à–∏–±–∫–∏!

### 2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ–π –≤ –∏–Ω–¥–µ–∫—Å–µ**
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—É—Ç—è–º–∏:
- `/app/documents/raw_uploads/Golden Visa...` (–∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å)
- `documents/raw_uploads/Golden Visa...` (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å)

**–í–ª–∏—è–Ω–∏–µ:** 
- LightRAG –º–æ–≥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∞–π–ª –¥–≤–∞–∂–¥—ã
- –ò–Ω–¥–µ–∫—Å –±—ã–ª –∑–∞–≥—Ä—è–∑–Ω–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏
- –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–∏—Å–∫–æ–º –∏–∑-–∑–∞ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

## –†–µ—à–µ–Ω–∏—è

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

**1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π rag_agent.py
docker cp app/agent/rag_agent.py lightrag-api:/app/app/agent/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker restart lightrag-api
```

**2. –û—á–∏—Å—Ç–∏—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –∏–Ω–¥–µ–∫—Å–µ:**
```bash
# –ß–µ—Ä–µ–∑ API
curl -X POST https://api.businessindunes.ai/documents/ingest/cleanup-duplicates \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# –ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker exec -it lightrag-api python3 fix_duplicate_paths.py
```

### –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞)

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
docker-compose down
docker-compose build --no-cache lightrag-api
docker-compose up -d
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
curl -X GET https://api.businessindunes.ai/documents/ingest/list \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —á–∏—Å—Ç—ã–µ –ø—É—Ç–∏ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
```json
{
  "index": [
    {"file": "raw_uploads/Golden Visa ‚Äì Skilled Professionals (knowledge workers) (1).md"}
  ]
}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ /chat
```bash
curl -X POST https://api.businessindunes.ai/chat \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∑–æ–ª–æ—Ç—É—é –≤–∏–∑—É"}'
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∞ –Ω–µ –æ—à–∏–±–∫—É retrieve.

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå `/chat` –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π `name 'query_length' is not defined`
- ‚ùå –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ
- ‚ùå –ò–Ω–¥–µ–∫—Å —Å–æ–¥–µ—Ä–∂–∞–ª –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—É—Ç–µ–π

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ RAG retrieve —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ò–Ω–¥–µ–∫—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—É—Ç–∏ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ `/chat` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## –°–≤—è–∑—å –º–µ–∂–¥—É –ø—Ä–æ–±–ª–µ–º–∞–º–∏

–•–æ—Ç—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ–π –∏ –æ—à–∏–±–∫–∞ `query_length` - —ç—Ç–æ –¥–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –æ–Ω–∏ –≤–º–µ—Å—Ç–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ, —á—Ç–æ "–¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è":

1. **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ `query_length` –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –ø–æ–ª–Ω–æ–º—É –æ—Ç–∫–∞–∑—É —Ñ—É–Ω–∫—Ü–∏–∏ retrieve
2. **–£—Å—É–≥—É–±–ª—è—é—â–∏–π —Ñ–∞–∫—Ç–æ—Ä:** –î–∞–∂–µ –µ—Å–ª–∏ –±—ã retrieve —Ä–∞–±–æ—Ç–∞–ª, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ–π –º–æ–≥–ª–æ –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–∏—Å–∫–æ–º

–¢–µ–ø–µ—Ä—å –æ–±–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –∏ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ —Ç–∏–ø–∞ `NameError`
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —á–µ—Ä–µ–∑ `/chat`
3. **–û—á–∏—Å—Ç–∫–∞:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ cleanup-duplicates –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —á–∏—Å—Ç–æ—Ç—ã –∏–Ω–¥–µ–∫—Å–∞
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã